<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyderabad Weather Forecast</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght=100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.5s ease;
        }
        /* Custom gradient for a pleasant look */
        .weather-card-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
            transition: all 0.5s ease;
        }
        /* Style for disabled BLE button */
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(10%);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Weather Card Container -->
    <div id="weatherCard" class="weather-card-bg w-full max-w-sm mx-auto rounded-3xl p-8 text-white transform hover:scale-[1.02] transition duration-300">

        <!-- Header and City -->
        <header class="mb-6">
            <h1 class="text-3xl font-extrabold text-center" id="cityDisplay">Fetching Weather...</h1>
            <p class="text-sm font-light text-center opacity-75" id="dateDisplay"></p>
        </header>

        <!-- Loading State / Error State -->
        <div id="loadingState" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-white mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg">One moment, please...</p>
        </div>

        <!-- Weather Data Display (Hidden initially) -->
        <div id="weatherData" class="hidden text-center">
            
            <!-- Temperature and Icon -->
            <div class="flex flex-col items-center justify-center my-6">
                <img id="weatherIcon" src="" alt="Weather Icon" class="w-20 h-20 mb-2">
                <span class="text-7xl font-light" id="temperatureDisplay">--</span>
                <span class="text-xl font-medium opacity-80" id="conditionDisplay"></span>
            </div>

            <!-- Details: Wind and Humidity -->
            <div class="bg-white bg-opacity-10 p-4 rounded-xl flex justify-around mt-8 shadow-inner">
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold" id="windSpeed">--</span>
                    <span class="text-xs opacity-75">Wind (km/h)</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-2xl font-bold" id="humidity">--</span>
                    <span class="text-xs opacity-75">Humidity (%)</span>
                </div>
            </div>

            <!-- BLE Output Section -->
            <div class="mt-8 pt-4 border-t border-white border-opacity-20">
                <h3 class="text-sm font-semibold opacity-80 mb-2">ESP32 BLE Data String</h3>
                <code id="bleOutput" class="block w-full text-xs text-left bg-white bg-opacity-10 p-2 rounded-lg break-all">
                    Loading...
                </code>
                <!-- New button for sending data -->
                <button id="sendBleDataButton" class="mt-2 w-full bg-green-600 text-white font-bold py-2 rounded-xl hover:bg-green-700 transition duration-150 shadow-md btn-disabled" disabled>
                    Send Data via Bluetooth
                </button>
                <p id="sendDataStatus" class="text-xs text-center mt-1 opacity-75 hidden">Data Sent!</p>
            </div>
            
            <!-- Fetch Button and Status -->
            <button id="manualFetchButton" class="mt-4 w-full bg-blue-500 text-white font-bold py-2 rounded-xl hover:bg-blue-600 transition duration-150 shadow-md">
                Manually Update Weather
            </button>
            <p id="fetchStatus" class="text-xs text-center mt-1 text-green-300 hidden">Last fetch: --</p>

            <!-- BLE Connection Section -->
            <div class="mt-4 pt-4 border-t border-white border-opacity-20">
                <button id="bleConnectButton" class="w-full bg-green-500 text-white font-bold py-2 rounded-xl hover:bg-green-600 transition duration-150 shadow-md">
                    Connect via Bluetooth
                </button>
                <p id="bluetoothStatus" class="text-xs text-center mt-1 text-yellow-300">Status: Disconnected</p>
            </div>

        </div>

        <!-- Footer for Last Updated Time -->
        <footer class="mt-8 text-center text-xs opacity-60">
            <p id="lastUpdated">Last updated: --</p>
        </footer>

    </div>

    <script>
        // --- Configuration ---
        const API_KEY = "f433f239860742c1b8e134145252510";
        const CITY = "Hyderabad";
        const API_URL = `https://api.weatherapi.com/v1/current.json?key=${API_KEY}&q=${CITY}`;
        const WEATHER_REFRESH_INTERVAL = 120000; // 2 minutes in ms
        const TIME_REFRESH_INTERVAL = 5000; // 5 seconds in ms
        const MAX_ATTEMPTS = 3;
        
        // --- BLE Configuration (MUST BE UPDATED FOR YOUR ESP32) ---
        // NOTE: Replace these UUIDs with the actual ones used in your ESP32 code.
        const SERVICE_UUID = '9a1b2c3d-4e5f-6a70-8b9c-0d1e2f3a4b5c'; 
        const CHARACTERISTIC_UUID = '1a2b3c4d-5e6f-7a80-9b0c-1d2e3f4a5b6c';

        // --- Global State ---
        let lastWeatherData = null; 
        let fetchIntervalId = null; 
        let bleCharacteristic = null; // Stored characteristic for sending data
        let bleDevice = null; // Stored device reference

        // --- DOM Elements ---
        const weatherCard = document.getElementById('weatherCard');
        const loadingState = document.getElementById('loadingState');
        const weatherData = document.getElementById('weatherData');
        const cityDisplay = document.getElementById('cityDisplay');
        const dateDisplay = document.getElementById('dateDisplay');
        const temperatureDisplay = document.getElementById('temperatureDisplay');
        const conditionDisplay = document.getElementById('conditionDisplay');
        const weatherIcon = document.getElementById('weatherIcon');
        const windSpeed = document.getElementById('windSpeed');
        const humidity = document.getElementById('humidity');
        const lastUpdated = document.getElementById('lastUpdated');
        const bleOutput = document.getElementById('bleOutput');
        const sendBleDataButton = document.getElementById('sendBleDataButton'); // Renamed button
        const sendDataStatus = document.getElementById('sendDataStatus'); // Status for data send
        const manualFetchButton = document.getElementById('manualFetchButton');
        const fetchStatus = document.getElementById('fetchStatus');
        const bleConnectButton = document.getElementById('bleConnectButton');
        const bluetoothStatus = document.getElementById('bluetoothStatus');


        // --- Helper Functions ---

        /**
         * Formats the local time for the main UI display (e.g., 3:45:00 PM).
         */
        function formatTimeUi(date) {
            const options = { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true };
            return date.toLocaleTimeString('en-US', options);
        }

        /**
         * Formats the time specifically for the ESP32 BLE string (HH:MM 24-hour format).
         */
        function formatTimeBle() {
            const date = new Date();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        /**
         * Generates the string for the ESP32 BLE receiver.
         * Format: time=HH:MM;cond=Condition;temp=XXC
         */
        function generateBleString(current) {
            let condition = current.condition.text;
            
            // Apply the user's specific replacement: "mist" -> "Partly cloudy"
            if (condition.toLowerCase() === 'mist') {
                condition = 'Partly cloudy';
            }

            const time = formatTimeBle(); // Use current browser time
            const temp = Math.round(current.temp_c);
            
            return `time=${time};cond=${condition};temp=${temp}Â°C`;
        }
        
        /**
         * Updates the UI elements that rely on the current time (runs every 5s).
         */
        function updateTimeAndBleString() {
            if (!lastWeatherData) return;
            
            const localTime = new Date(); 
            
            // 1. Update main date display (including seconds)
            dateDisplay.textContent = localTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + 
                                      ' | ' + formatTimeUi(localTime);

            // 2. Regenerate BLE string using the last known weather condition/temp and the current time
            const bleString = generateBleString(lastWeatherData.current);
            bleOutput.textContent = bleString;
        }

        /**
         * Updates the UI after a successful API fetch.
         * @param {object} data The weather data object.
         */
        function updateUI(data) {
            const current = data.current;
            const location = data.location;
            
            lastWeatherData = data; 

            // Update Header
            cityDisplay.textContent = location.name;

            // Update Main Data
            temperatureDisplay.innerHTML = `${Math.round(current.temp_c)}&deg;C`;
            
            let conditionText = current.condition.text;
            if (conditionText.toLowerCase() === 'mist') {
                conditionText = 'Partly cloudy';
            }
            conditionDisplay.textContent = conditionText;
            
            // Set Icon
            weatherIcon.src = `https:${current.condition.icon}`;
            weatherIcon.alt = current.condition.text;

            // Update Details
            windSpeed.textContent = current.wind_kph;
            humidity.textContent = current.humidity;

            // Update Footer (last updated time from the API source)
            lastUpdated.textContent = `API data updated: ${formatTimeUi(new Date(current.last_updated.replace(' ', 'T')))}`;
            
            updateTimeAndBleString(); 

            // Show data and hide loader
            loadingState.classList.add('hidden');
            weatherData.classList.remove('hidden');

            // Change background color based on day/night
            const nightBg = 'linear-gradient(135deg, #0f172a 0%, #1e40af 100%)';
            const dayBg = 'linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%)';
            const bodyNightBg = '#1f2937';
            const bodyDayBg = '#f3f4f6';
            
            weatherCard.style.background = current.is_day === 0 ? nightBg : dayBg;
            document.body.style.backgroundColor = current.is_day === 0 ? bodyNightBg : bodyDayBg;

            // Automatically send data after a successful manual fetch (optional feature)
            // if (isManual && bleCharacteristic) {
            //     sendBleData();
            // }
        }

        /**
         * Updates the status message below the manual fetch button.
         */
        function updateFetchStatus(success, isManual) {
            const now = new Date();
            const time = formatTimeUi(now);
            
            fetchStatus.classList.remove('hidden', 'text-red-300', 'text-green-300');
            
            if (success) {
                fetchStatus.textContent = `Last weather fetch: ${time} (${isManual ? 'Manual' : 'Auto'})`;
                fetchStatus.classList.add('text-green-300');
            } else {
                fetchStatus.textContent = `Fetch FAILED at: ${time}`;
                fetchStatus.classList.add('text-red-300');
            }
        }

        /**
         * Fetches weather data with basic exponential backoff for retries.
         */
        async function fetchWeather(attempt = 1, isManual = false) {
            
            if (attempt === 1 && !lastWeatherData) {
                loadingState.classList.remove('hidden');
                weatherData.classList.add('hidden');
            }
            
            try {
                const response = await fetch(API_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                updateUI(data);
                updateFetchStatus(true, isManual);
                
                manualFetchButton.disabled = false;
                manualFetchButton.textContent = 'Manually Update Weather';

            } catch (error) {
                console.error(`Attempt ${attempt} failed:`, error.message);
                
                if (attempt < MAX_ATTEMPTS) {
                    const delay = Math.pow(2, attempt) * 1000;
                    setTimeout(() => fetchWeather(attempt + 1, isManual), delay);
                } else {
                    cityDisplay.textContent = "Data Unavailable";
                    lastUpdated.textContent = "Could not load weather after multiple attempts.";
                    loadingState.classList.add('hidden');
                    weatherData.classList.remove('hidden'); 
                    bleOutput.textContent = "Error fetching data.";
                    updateFetchStatus(false, isManual);
                    
                    manualFetchButton.disabled = false;
                    manualFetchButton.textContent = 'Manually Update Weather';
                }
            }
        }
        
        // --- BLE Logic ---

        /**
         * Sets the BLE connection UI state.
         * @param {string} statusText The text to display.
         * @param {string} colorClass Tailwind text color class (e.g., 'text-green-300').
         * @param {boolean} isConnected If true, enables send button and changes connect button text/color.
         */
        function updateBleStatus(statusText, colorClass, isConnected) {
            bluetoothStatus.textContent = `Status: ${statusText}`;
            bluetoothStatus.classList.remove('text-green-300', 'text-yellow-300', 'text-red-300');
            bluetoothStatus.classList.add(colorClass);

            if (isConnected) {
                sendBleDataButton.disabled = false;
                sendBleDataButton.classList.remove('btn-disabled');
                bleConnectButton.textContent = 'Disconnect';
                bleConnectButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                bleConnectButton.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                sendBleDataButton.disabled = true;
                sendBleDataButton.classList.add('btn-disabled');
                bleConnectButton.textContent = 'Connect via Bluetooth';
                bleConnectButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                bleConnectButton.classList.add('bg-green-500', 'hover:bg-green-600');
            }
            bleConnectButton.disabled = false;
        }

        /**
         * Handles the GATT server disconnection event.
         */
        function onDisconnected(event) {
            console.log(`Device ${event.target.name} disconnected.`);
            bleCharacteristic = null;
            bleDevice = null;
            updateBleStatus("Disconnected", 'text-red-300', false);
        }

        /**
         * Attempts to send the current BLE data string to the connected characteristic.
         */
        async function sendBleData() {
            if (!bleCharacteristic || !bleCharacteristic.service.device.gatt.connected) {
                updateBleStatus("Error - Not Connected", 'text-red-300', false);
                console.error("Cannot send data: Characteristic is unavailable or device disconnected.");
                return;
            }

            const data = bleOutput.textContent;
            
            try {
                // Encode the string data to a byte array
                const encoder = new TextEncoder();
                await bleCharacteristic.writeValue(encoder.encode(data));
                
                sendDataStatus.textContent = `Sent at ${formatTimeUi(new Date())}`;
                sendDataStatus.classList.remove('hidden');
                setTimeout(() => { sendDataStatus.classList.add('hidden'); }, 3000);
                
                console.log("BLE data successfully sent:", data);

            } catch (error) {
                sendDataStatus.textContent = `Failed to send! Error: ${error.message.substring(0, 30)}...`;
                sendDataStatus.classList.remove('hidden');
                sendDataStatus.classList.remove('opacity-75');
                sendDataStatus.classList.add('text-red-300');
                setTimeout(() => { 
                    sendDataStatus.classList.add('hidden'); 
                    sendDataStatus.classList.remove('text-red-300');
                    sendDataStatus.classList.add('opacity-75');
                }, 5000);
                
                console.error("Error writing BLE characteristic:", error);
            }
        }


        /**
         * Attempts to connect to an ESP32 device via Web Bluetooth.
         */
        async function connectBle() {
            if (bleDevice && bleDevice.gatt.connected) {
                // Handle Disconnect action
                bleDevice.gatt.disconnect();
                updateBleStatus("Disconnecting...", 'text-yellow-300', false);
                bleConnectButton.disabled = true;
                return;
            }

            if (!navigator.bluetooth) {
                updateBleStatus("Error - Web Bluetooth not supported by browser.", 'text-red-300', false);
                return;
            }

            bleConnectButton.disabled = true;
            updateBleStatus("Scanning...", 'text-yellow-300', false);

            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }]
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                updateBleStatus(`Connecting to ${bleDevice.name || 'Unknown Device'}...`, 'text-yellow-300', false);

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                updateBleStatus("Connected!", 'text-green-300', true);
                console.log("Successfully connected to GATT server.");

            } catch (error) {
                bleCharacteristic = null;
                bleDevice = null;
                updateBleStatus(`Disconnected/Error (${error.name})`, 'text-red-300', false);
                console.error("BLE Connection Error:", error);
            } finally {
                if (!bleDevice || !bleDevice.gatt.connected) {
                    bleConnectButton.disabled = false;
                }
            }
        }
        
        /**
         * Main function to set up timers and listeners.
         */
        function initializeApp() {
            // 1. Initial weather fetch
            fetchWeather(1, false); 
            
            // 2. Set 5-second timer for time update/BLE string update
            setInterval(updateTimeAndBleString, TIME_REFRESH_INTERVAL); 
            
            // 3. Set 2-minute timer for weather fetch
            fetchIntervalId = setInterval(() => fetchWeather(1, false), WEATHER_REFRESH_INTERVAL); 

            // 4. Attach manual fetch button listener
            manualFetchButton.addEventListener('click', () => {
                manualFetchButton.disabled = true;
                manualFetchButton.textContent = 'Updating...';
                
                clearInterval(fetchIntervalId); 
                fetchWeather(1, true); 
                fetchIntervalId = setInterval(() => fetchWeather(1, false), WEATHER_REFRESH_INTERVAL); 
            });

            // 5. Attach BLE connect/disconnect button listener
            bleConnectButton.addEventListener('click', connectBle);

            // 6. Attach BLE send data button listener
            sendBleDataButton.addEventListener('click', sendBleData);
        }

        // Initialize the app on load
        window.onload = initializeApp;
    </script>

</body>
</html>
