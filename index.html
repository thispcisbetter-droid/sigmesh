<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE Clock Sender</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to ensure the container feels like a mobile app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4">
    <div id="app" class="w-full max-w-sm bg-white shadow-2xl rounded-3xl p-6 md:p-8 space-y-6 transform transition duration-500">
        <h1 class="text-3xl font-extrabold text-indigo-700 text-center">
            ESP32 Clock Sender
        </h1>
        <p class="text-sm text-gray-500 text-center">
            Automatic updates: Time (5s) / WeatherAPI Fetch (120s).
        </p>

        <!-- WARNING: API KEY EXPOSURE -->
        <div class="p-2 text-xs text-red-700 bg-red-100 border border-red-300 rounded-md">
            ⚠️ **Security Warning:** Your API key is visible in this public client-side code. This is only suitable for personal testing.
        </div>

        <!-- Connection Status Indicator -->
        <div class="flex items-center space-x-2 p-3 rounded-xl bg-gray-100 shadow-inner">
            <span id="connection-status" class="w-3 h-3 rounded-full bg-red-500 transition-colors duration-300"></span>
            <span id="status-text" class="text-sm font-semibold text-red-700">Disconnected</span>
        </div>

        <!-- Location and Weather Display -->
        <div class="space-y-4">
            <div class="p-4 bg-white rounded-xl border border-gray-200">
                <p class="text-xs font-medium text-gray-500">LOCATION (WeatherAPI)</p>
                <p id="location-display" class="text-xl font-bold text-gray-800">Loading Configuration...</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="p-4 bg-white rounded-xl border border-gray-200">
                    <p class="text-xs font-medium text-gray-500">TEMPERATURE</p>
                    <p id="temp-display-val" class="text-2xl font-bold text-orange-600">--°C</p>
                </div>
                <div class="p-4 bg-white rounded-xl border border-gray-200">
                    <p class="text-xs font-medium text-gray-500">CONDITION</p>
                    <p id="weather-display-val" class="text-xl font-bold text-blue-600">--</p>
                </div>
            </div>
        </div>
        
        <!-- Time Display (Always visible) -->
        <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-200 text-center">
            <p class="text-xs font-medium text-indigo-500">TIME TO SEND</p>
            <p id="current-time-display" class="text-5xl font-black text-indigo-800">--:--</p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col space-y-4 pt-2">
            <button id="connect-button" 
                    class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition transform duration-150 active:scale-95 disabled:opacity-50"
                    onclick="connectToDevice()">
                Connect and Start Automatic Send
            </button>
            
            <button id="disconnect-button" 
                    class="w-full py-3 bg-red-500 text-white font-semibold rounded-xl shadow-lg hover:bg-red-600 transition transform duration-150 active:scale-95 disabled:opacity-50"
                    onclick="disconnectAndStop()" disabled>
                Disconnect
            </button>
        </div>

        <!-- Message/Log Area -->
        <p id="log-message" class="text-xs text-center text-gray-600 min-h-4">Click Connect to start transferring real-time weather data.</p>
    </div>

    <script>
        // --- API & LOCATION CONFIGURATION (Using WeatherAPI.com) ---
        const WEATHERAPI_KEY = 'f433f239860742c1b8e134145252510';
        const CITY = 'Hyderabad';
        
        // --- BLE CONFIGURATION (MUST match the ESP32 code) ---
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const DEVICE_NAME = 'ESP32-OLED-Clock';
        
        // --- TIMING CONFIGURATION (User Request) ---
        const TIME_SEND_INTERVAL = 5000;         // Time sent every 5 seconds
        const WEATHER_UPDATE_INTERVAL = 120000;  // Weather fetched every 2 minutes

        let bleDevice;
        let bleCharacteristic;
        let isConnected = false;
        let sendInterval;       // 5-second timer for BLE
        let weatherUpdateTimer; // 2-minute timer for API fetch

        // --- CACHED WEATHER DATA ---
        let currentTemp = '--';
        let currentWeather = 'N/A';
        
        // --- UI Element References ---
        const statusIndicator = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const logMessage = document.getElementById('log-message');
        const timeDisplay = document.getElementById('current-time-display');
        const locationDisplay = document.getElementById('location-display');
        const tempDisplayVal = document.getElementById('temp-display-val');
        const weatherDisplayVal = document.getElementById('weather-display-val');

        // --- UTILITY FUNCTIONS ---
        function updateUI(status, text, color) {
            statusIndicator.className = `w-3 h-3 rounded-full bg-${color}-500 transition-colors duration-300`;
            statusText.className = `text-sm font-semibold text-${color}-700`;
            statusText.textContent = text;

            if (status === 'connected') {
                connectButton.disabled = true;
                disconnectButton.disabled = false;
            } else {
                connectButton.disabled = false;
                disconnectButton.disabled = true;
            }
        }

        function writeLog(message) {
            logMessage.textContent = message;
        }
        
        // --- DISCONNECT / STOP ---
        function disconnectAndStop() {
            clearInterval(sendInterval);
            clearInterval(weatherUpdateTimer);

            if (bleDevice && bleDevice.gatt && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            }
            isConnected = false;
            updateUI('disconnected', 'Disconnected.', 'red');
            writeLog('Connection terminated. All timers stopped.');
        }

        // --- WEATHER API FETCH (Runs every 120 seconds) ---
        async function fetchWeatherData() {
            writeLog('Fetching new weather data from WeatherAPI...');
            
            // WeatherAPI endpoint for current weather in Celsius
            const apiUrl = `https://api.weatherapi.com/v1/current.json?key=${WEATHERAPI_KEY}&q=${CITY}&aqi=no`;
            
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. Check API Key or City name.`);
                }
                const data = await response.json();

                // Parse data specific to WeatherAPI.com
                const temp = data.current.temp_c.toFixed(1);
                // Use the condition text and limit the length to prevent ESP32 buffer overflow
                const condition = data.current.condition.text.substring(0, 16); 

                // Update global cache
                currentTemp = temp;
                currentWeather = condition;

                // Update UI display
                tempDisplayVal.textContent = `${currentTemp}°C`;
                weatherDisplayVal.textContent = currentWeather;
                writeLog(`Weather updated: ${currentWeather}, ${currentTemp}°C. Next update in 2 min.`);

            } catch (error) {
                // If API call fails, continue using the last valid data (or initial fallback)
                writeLog(`WeatherAPI Error: ${error.message}. Using cached data.`);
            }
        }

        // --- Data Generation (Called every 5 seconds) ---
        function generateAndFormatData() {
            const dateObj = new Date();
            
            const timeStr = `${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}`;
            
            // Use the globally cached Temp and Weather Condition
            const tempStr = currentTemp;
            const weatherStr = currentWeather;
            
            // Data format: HH:MM,TT.TC,WeatherCondition
            const data = `${timeStr},${tempStr}C,${weatherStr}`;

            // Update local time display
            timeDisplay.textContent = timeStr;

            return data;
        }

        // --- BLE Data Sending Logic (Called every 5 seconds) ---
        async function sendData() {
            if (!isConnected || !bleCharacteristic) return;

            try {
                const dataString = generateAndFormatData();
                const dataArray = new TextEncoder().encode(dataString);
                
                await bleCharacteristic.writeValue(dataArray);
                
                writeLog(`Time update sent: ${dataString.substring(0, 5)} (Temp/Weather: ${currentTemp}°C, ${currentWeather})`);
            } catch (error) {
                writeLog(`Send Error: ${error.message}. Disconnecting due to failure...`);
                disconnectAndStop();
            }
        }
        
        // --- BLE Connection Logic ---
        async function connectToDevice() {
            if (isConnected) {
                writeLog('Already running. Use the Disconnect button.');
                return;
            }
            
            updateUI('connecting', 'Connecting...', 'yellow');
            
            try {
                if (!navigator.bluetooth) {
                    throw new Error("Web Bluetooth not supported by this browser/device.");
                }

                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                });

                // Set up listener for physical disconnection
                bleDevice.addEventListener('gattserverdisconnected', disconnectAndStop);

                writeLog(`Found device: ${bleDevice.name}. Connecting...`);

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                isConnected = true;
                updateUI('connected', `Connected to ${DEVICE_NAME}`, 'green');
                
                // 1. Fetch data immediately and then start the 2-minute weather timer
                await fetchWeatherData(); 
                clearInterval(weatherUpdateTimer);
                weatherUpdateTimer = setInterval(fetchWeatherData, WEATHER_UPDATE_INTERVAL);

                // 2. Start the 5-second continuous sending timer
                clearInterval(sendInterval);
                sendInterval = setInterval(sendData, TIME_SEND_INTERVAL); 

                writeLog(`Connected! Initial data sent. Time updates every 5s.`);

            } catch (error) {
                isConnected = false;
                updateUI('disconnected', 'Disconnected (Error)', 'red');
                writeLog(`Connection Error: ${error.message}. Ensure ESP32 is on and Web Bluetooth works.`);
                clearInterval(sendInterval);
                clearInterval(weatherUpdateTimer);
            }
        }
        
        // Initial setup on load
        window.onload = () => {
             // Set location display
             locationDisplay.textContent = CITY;
             
             // Start the client-side clock display
             setInterval(() => {
                const now = new Date();
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                timeDisplay.textContent = timeStr;
            }, 1000);
        };
    </script>
</body>
</html>
