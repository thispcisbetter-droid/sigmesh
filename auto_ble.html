<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Auto-Send BLE Clock</title>
    <!-- Load Tailwind CSS for simple, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .btn { transition: background-color 0.3s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md bg-white p-6 rounded-xl card space-y-6">
        <h1 class="text-2xl font-bold text-gray-800 text-center">Auto-Send BLE Clock Controller</h1>
        <p class="text-sm text-gray-500 text-center font-bold text-red-600">
            !!! THIS APP MUST BE HOSTED ON A SECURE HTTPS LINK TO WORK !!!
        </p>
        
        <!-- Connection Status & Button -->
        <div class="space-y-4">
            <button id="connectButton" onclick="connect()" 
                    class="btn w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                Connect to ESP32
            </button>
            <div id="status" class="p-3 text-center rounded-lg text-sm bg-blue-100 text-blue-800">
                Status: Disconnected. Click 'Connect'.
            </div>
            <div id="autoSendStatus" class="p-3 text-center rounded-lg text-sm bg-gray-200 text-gray-700">
                Auto-Send: Inactive
            </div>
        </div>

        <!-- Static Data Input -->
        <div class="space-y-4 pt-4 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700">Static Data Settings</h2>

            <!-- Temperature Input (Static, since we can't get live weather in JS easily) -->
            <div>
                <label for="inputTemp" class="block text-sm font-medium text-gray-700 mb-1">Temperature (°C) - Static</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="number" id="inputTemp" value="23.0" step="0.1" 
                           class="block w-full pr-12 rounded-md border-gray-300 p-3 border focus:border-indigo-500 focus:ring-indigo-500">
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                        <span class="text-gray-500 sm:text-sm">°C</span>
                    </div>
                </div>
            </div>

            <!-- Weather Input (Static) -->
            <div>
                <label for="inputWeather" class="block text-sm font-medium text-gray-700 mb-1">Weather Condition - Static</label>
                <select id="inputWeather" 
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border bg-white focus:border-indigo-500 focus:ring-indigo-500">
                    <option value="Sunny">Sunny</option>
                    <option value="Cloudy" selected>Cloudy</option>
                    <option value="Rain">Rain</option>
                    <option value="Clear Night">Clear Night</option>
                    <option value="Thunderstorm">Thunderstorm</option>
                </select>
            </div>
            
            <p class="text-xs text-gray-500 pt-2">
                *Time is automatically fetched from your device's system clock.
            </p>
        </div>
    </div>

    <script>
        // --- BLE Configuration (MUST match ESP32 code) ---
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const DEVICE_NAME = 'ESP32-OLED-Clock';
        const SEND_INTERVAL_MS = 5000; // Auto-send every 5 seconds

        let bleDevice;
        let dataCharacteristic;
        let isConnected = false;
        let sendTimer = null; // Variable to hold the interval timer

        const statusElement = document.getElementById('status');
        const connectButton = document.getElementById('connectButton');
        const autoSendStatusElement = document.getElementById('autoSendStatus');
        const inputTemp = document.getElementById('inputTemp');
        const inputWeather = document.getElementById('inputWeather');

        /**
         * Utility function to update the status message on the UI.
         */
        function updateStatus(message, isError = false) {
            statusElement.textContent = `Status: ${message}`;
            statusElement.className = `p-3 text-center rounded-lg text-sm ${isError ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
        }

        /**
         * Converts a Date object to "HH:MM" format.
         */
        function getCurrentTimeFormatted() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        /**
         * Formats and sends the data to the ESP32 characteristic.
         */
        async function sendData() {
            if (!isConnected || !dataCharacteristic) {
                // If the timer is still running but we lost connection, stop the timer.
                if(sendTimer) stopAutoSend(); 
                updateStatus('Not connected. Auto-send stopped.', true);
                return;
            }

            // 1. Get live time from phone/system
            const time = getCurrentTimeFormatted(); 
            // 2. Get static data from input fields
            const temp = parseFloat(inputTemp.value).toFixed(1);
            const weather = inputWeather.value; 

            // Construct the required string: "HH:MM,TT.TC,WeatherCondition"
            const dataString = `${time},${temp}C,${weather}`;

            // Convert string to an ArrayBuffer using UTF-8
            const encoder = new TextEncoder();
            const dataToSend = encoder.encode(dataString);
            
            try {
                // Write the value to the characteristic
                await dataCharacteristic.writeValue(dataToSend);
                autoSendStatusElement.textContent = `Auto-Send: Running | Sent: ${time}`;
                console.log(`Data Sent: ${dataString}`);
            } catch (error) {
                updateStatus(`Send Error: ${error.message}. Stopping auto-send.`, true);
                console.error("BLE Write Error:", error);
                stopAutoSend(); // Stop if there's a transmission error
            }
        }

        /**
         * Starts the periodic data sending timer.
         */
        function startAutoSend() {
            if (sendTimer) clearInterval(sendTimer); // Clear any existing timer
            sendTimer = setInterval(sendData, SEND_INTERVAL_MS);
            autoSendStatusElement.textContent = `Auto-Send: Starting (Every ${SEND_INTERVAL_MS / 1000}s)`;
            // Run once immediately
            sendData(); 
        }

        /**
         * Stops the periodic data sending timer.
         */
        function stopAutoSend() {
            if (sendTimer) {
                clearInterval(sendTimer);
                sendTimer = null;
            }
            autoSendStatusElement.textContent = 'Auto-Send: Inactive';
        }


        /**
         * Connects to the ESP32 via Web Bluetooth.
         */
        async function connect() {
            if (!navigator.bluetooth) {
                 updateStatus('Browser does not support Web Bluetooth.', true);
                 return;
            }

            if (isConnected) {
                // Disconnect logic
                stopAutoSend();
                if (bleDevice && bleDevice.gatt.connected) {
                    bleDevice.gatt.disconnect();
                } else {
                     updateStatus('Disconnected unexpectedly. Click Connect to restart.');
                     onDisconnected();
                }
                return;
            }

            updateStatus('Scanning for device...');
            connectButton.disabled = true;

            try {
                // 1. Request the device
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus(`Connecting to ${bleDevice.name}...`);
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                // 2. Connect to the GATT server
                const server = await bleDevice.gatt.connect();

                // 3. Get the Service and Characteristic
                const service = await server.getPrimaryService(SERVICE_UUID);
                dataCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                isConnected = true;
                connectButton.textContent = 'Connected (Click to Disconnect)';
                connectButton.className = connectButton.className.replace('bg-indigo-600 hover:bg-indigo-700', 'bg-red-600 hover:bg-red-700');
                updateStatus(`Successfully connected to ${bleDevice.name}.`);
                
                // --- Start Auto-Send on Successful Connection ---
                startAutoSend();

            } catch (error) {
                // This is where the SecurityError comes from.
                updateStatus(`Connection Error: ${error.message}. Check your hosting environment!`, true);
                console.error("Connection failed:", error);
                onDisconnected();
            } finally {
                connectButton.disabled = false;
            }
        }

        /**
         * Handler for when the device disconnects (expected or unexpected).
         */
        function onDisconnected(event) {
            console.log('Device disconnected.');
            stopAutoSend();
            isConnected = false;
            connectButton.textContent = 'Connect to ESP32';
            connectButton.className = connectButton.className.replace('bg-red-600 hover:bg-red-700', 'bg-indigo-600 hover:bg-indigo-700');
            updateStatus('Disconnected. Auto-send stopped.', true);
        }

    </script>
</body>
</html>
